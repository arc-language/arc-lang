//@test(expect = "start\nend\ncleanup_called\n")
namespace main

extern c {
    func fopen(*byte, *byte) *FILE
    func fprintf(*FILE, *byte, ...) int32
    func fclose(*FILE) int32
    func fread(*byte, uint64, uint64, *FILE) uint64
    func printf(*byte, ...) int32
}

struct FILE {
    // Opaque - we don't need to know the internal structure
    // C's FILE* is treated as a pointer to this struct
}

func cleanup(file: *FILE) {
    fprintf(file, "cleanup_called\n")
    fclose(file)
    
    // Reopen and read back the file to stdout
    let read_file: *FILE = fopen("/tmp/myfile.txt", "r")
    let buffer: [100]byte = {}
    fread(&buffer, 1, 100, read_file)
    fclose(read_file)
    
    // Print to stdout for test verification
    printf("%s", &buffer)
}

func main() int32 {
    let file: *FILE = fopen("/tmp/myfile.txt", "w")
    
    fprintf(file, "start\n")
    defer cleanup(file)
    fprintf(file, "end\n")
    
    return 0
}